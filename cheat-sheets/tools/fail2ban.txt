Атака на SSH сервер, как защититься? Использование fail2ban

Эти логи из `journalctl` показывают сообщения об ошибках, связанных с попытками
подключения по SSH к серверу. Давайте разберем каждую строку:

sshd[493469]: error: kex_protocol_error: type 20 seq 2 [preauth]`
sshd[493469]: error: kex_protocol_error: type 30 seq 3 [preauth]`
sshd[493491]: error: kex_protocol_error: type 20 seq 2 [preauth]`
sshd[493491]: error: kex_protocol_error: type 30 seq 3 [preauth]`
sshd[493921]: error: kex_exchange_identification: client sent invalid protocol identifier "GET / HTTP/1.1"`
sshd[494184]: error: kex_exchange_identification: banner line contains invalid characters`
sshd[494447]: error: kex_protocol_error: type 20 seq 2 [preauth]`
sshd[494447]: error: kex_protocol_error: type 30 seq 3 [preauth]`
sshd[490]: error: beginning MaxStartups throttling`
sshd[496274]: error: kex_protocol_error: type 20 seq 2 [preauth]`
sshd[496274]: error: kex_protocol_error: type 30 seq 3 [preauth]`

Объяснение ошибок:

1. kex_protocol_error:
Сообщение `kex_protocol_error: type 20 seq 2 [preauth]` и `kex_protocol_error:
type 30 seq 3 [preauth]` указывает на ошибки в процессе обмена ключами
(key exchange) на этапе предварительной аутентификации.Это может быть
связано с несовместимостью протоколов или ошибками в передаче данных.

2. kex_exchange_identification:
Сообщение `kex_exchange_identification: client sent invalid protocol identifier
"GET / HTTP/1.1"` указывает на то, что клиент отправил неверный идентификатор
протокола. В данном случае клиент попытался подключиться к SSH-серверу,
используя запрос HTTP, что является некорректным. Сообщение
`kex_exchange_identification: banner line contains invalid characters` указывает
на то, что строка баннера, отправленная клиентом, содержит недопустимые символы.

3. MaxStartups throttling:
Сообщение `beginning MaxStartups throttling` указывает на то, что сервер достиг
предела по количеству одновременных незавершенных попыток подключения (MaxStartups).
Это механизм защиты от DoS-атак, который ограничивает количество параллельных подключений.

Возможные причины:

- Попытки несанкционированного доступа или автоматизированные сканирования
  (боты, пытающиеся найти уязвимости).
- Ошибки конфигурации клиента или сервера SSH.
- Несовместимость протоколов между клиентом и сервером.

Рекомендации:

1. Проверка конфигурации:
   - Убедитесь, что конфигурация SSH-сервера корректна и соответствует
     требованиям безопасности.

2. Журналирование и мониторинг:
   - Продолжайте мониторинг логов для выявления подозрительной активности.

3. Ограничение доступа:
   - Ограничьте доступ к SSH по IP-адресам, если возможно.
   - Используйте firewall для блокировки подозрительных IP-адресов.

4. Обновление программного обеспечения:
   - Убедитесь, что SSH-сервер и клиент обновлены до последних версий.

5. Использование fail2ban:
   - Рассмотрите возможность использования fail2ban или аналогичных инструментов
     для автоматической блокировки IP-адресов, совершающих подозрительные
     попытки подключения.

Настройка fail2ban.

1. Проверьте конфигурационные файлы fail2ban:
   - Основной конфигурационный файл находится по пути `/etc/fail2ban/fail2ban.conf`.
   - Конфигурация для различных служб находится в `/etc/fail2ban/jail.conf`
     или `/etc/fail2ban/jail.d/`.

2. Настройка jail для sshd:
   - Убедитесь, что jail для sshd активен. Откройте файл `/etc/fail2ban/jail.local`
     (если его нет, создайте его) и добавьте или измените следующие строки:

     [sshd]
     enabled = true
     port = ssh
     filter = sshd
     logpath = /var/log/auth.log
     maxretry = 3
     bantime = 3600

3. Создание фильтра:
   - Фильтры определяют, какие строки в логах будут отслеживаться.
     Обычно файл фильтра для sshd уже существует и находится по пути
     `/etc/fail2ban/filter.d/sshd.conf`. Убедитесь, что он содержит правила для
     обнаружения ошибок, подобных тем, что вы видите в журналах.

4. Перезапуск fail2ban:
   - После внесения изменений перезапустите fail2ban, чтобы применить новые
     настройки:
     $ sudo systemctl restart fail2ban

5. Проверка работы:
   - Вы можете проверить, какие IP-адреса были заблокированы, с помощью команды:
     $ sudo fail2ban-client status sshd
     Эта команда покажет статус jail для sshd, включая количество
     заблокированных IP-адресов и текущие действия.

Дополнительные меры:

1. Проверка логов:
   - Регулярно проверяйте логи fail2ban, чтобы убедиться, что он правильно
     блокирует подозрительную активность:
     $ sudo tail -f /var/log/fail2ban.log

2. Обновление правил:
   - В случае появления новых типов атак, обновляйте фильтры fail2ban и правила
     для их обнаружения.

3. Защита других служб:
   - Если на сервере работают другие службы, рассмотрите возможность
     настройки fail2ban для их защиты.

В fail2ban можно настроить постоянную блокировку IP-адресов, установив параметр
`bantime` в значение, которое будет эквивалентно бесконечности `bantime = -1`.
Эту настройку можно добавить в файл `/etc/fail2ban/jail.local` и затем:
$ sudo systemctl restart fail2ban
